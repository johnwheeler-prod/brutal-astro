---
import LocalFont from '../generic/LocalFont.astro';

interface Props {
  title: string;
  description: string;
  ogImage?: URL;
  pageSchema?: Record<string, any>;
}

const canonicalURL = new URL(Astro.url.pathname, Astro.site);

if (Astro.props.ogImage === undefined) {
  Astro.props.ogImage = new URL('/v1/generate/og/default.png', Astro.url);
}

const { title, description, ogImage, pageSchema } = Astro.props;

const personSchema = {
  "@context": "https://schema.org",
  "@type": "Person",
  "name": "John Wheeler",
  "url": "https://www.johnwheelerproduction.com/",
  "jobTitle": "Software and Web Engineer",
  "sameAs": [
    "https://www.linkedin.com/in/john-wheeler",
    "https://github.com/johnwheeler"
  ]
};

const webSiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "url": "https://www.johnwheelerproduction.com/",
  "name": "John Wheeler Production",
  "description": "Portfolio of John Wheeler"
};
---

<head>
  <LocalFont />
  <meta charset='utf-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1' />
  <meta name='generator' content={Astro.generator} />

  <!-- Google Tag Manager (deferred) -->
  <script is:inline>
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });

    const loadGTM = () => {
      if (document.getElementById('gtm-script')) return;
      const gtmScript = document.createElement('script');
      gtmScript.id = 'gtm-script';
      gtmScript.async = true;
      gtmScript.src = 'https://www.googletagmanager.com/gtm.js?id=GTM-5DFDJZF8';
      document.head.appendChild(gtmScript);
    };

    if ('requestIdleCallback' in window) {
      requestIdleCallback(loadGTM, { timeout: 2000 });
    } else {
      window.addEventListener('load', () => setTimeout(loadGTM, 1000), { once: true });
    }
  </script>
  <!-- End Google Tag Manager -->

  <link
    rel='alternate'
    href='https://johnwheelerproduction.com/blog.xml'
    type='application/rss+xml'
  />

  <meta name='title' content={`John Wheeler | ${title}`} />
  <meta name='description' content={description} />

  <meta property='og:type' content='website' />
  <meta property='og:url' content={canonicalURL} />
  <meta property='og:title' content={title} />
  <meta property='og:description' content={description} />
  <meta property='og:image' content={ogImage} />

  <meta property='twitter:card' content='summary_large_image' />
  <meta property='twitter:url' content={canonicalURL} />
  <meta property='twitter:title' content={title} />
  <meta property='twitter:description' content={description} />
  <meta property='twitter:image' content={ogImage} />

  <link rel='canonical' href={canonicalURL} />
  <link rel='icon' type='image/svg' href='/favicon.svg' />

  <title>John Wheeler | {title}</title>

<!-- Global Schema -->
<script type="application/ld+json" set:html={JSON.stringify([personSchema, webSiteSchema])} is:inline></script>

<!-- Page Schema -->
{pageSchema && (
  <script type="application/ld+json" set:html={JSON.stringify(pageSchema)} is:inline></script>
)}

  <slot />
</head>
