<div class="spotify-container">
  <h2 class="text-2xl md:text-4xl lg:text-6xl mb-4 dm-serif">
    What I'm listening to
  </h2>

  <div class="spotify-content">
    <div class="current-album mb-6">
      <iframe
        id="spotify-frame"
        width="100%"
        height="352"
        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
        loading="lazy"
        style="border: 0; border-radius:12px"
      ></iframe>
    </div>
    <button id="spotify-load-btn" class="spotify-load">
      Load player
    </button>
  </div>
</div>

<script>
  type Album = { id: string };

  const albums: Album[] = [
    { id: '3hKlec1wgYVJcI0YvwCFJB' },
    { id: '5PKfMfQxsoapso8E9zu1A2' },
    { id: '1QZJzByKliJB2xyhgrYk4j' },
    { id: '3g4koxypokRF6kR3KA5F0P' },
    { id: '0U0Qv2jYtsgGxFDpQJKAxQ' },
    { id: '5QGv6b6i7tIOksucTpcUau' },
  ];

  const CYCLE_MS = 8000;

  const setAlbum = (index: number) => {
    const frame = document.getElementById('spotify-frame') as HTMLIFrameElement | null;
    const album = albums[index % albums.length];
    if (!frame || !album) return;
    frame.src = `https://open.spotify.com/embed/album/${album.id}?utm_source=generator`;
  };

  const startPlayer = () => {
    let currentIndex = 0;
    setAlbum(currentIndex);

    if (albums.length > 1) {
      setInterval(() => {
        currentIndex = (currentIndex + 1) % albums.length;
        setAlbum(currentIndex);
      }, CYCLE_MS);
    }
  };

  const bootOnInteraction = () => {
    const loadBtn = document.getElementById('spotify-load-btn');
    const frame = document.getElementById('spotify-frame') as HTMLIFrameElement | null;
    if (!loadBtn || !frame) return;

    const loadPlayer = () => {
      loadBtn.remove();
      startPlayer();
    };

    loadBtn.addEventListener('click', loadPlayer, { once: true });

    if ('IntersectionObserver' in window) {
      const observer = new IntersectionObserver((entries) => {
        if (entries.some((entry) => entry.isIntersecting)) {
          loadPlayer();
          observer.disconnect();
        }
      });
      observer.observe(frame);
    } else {
      // Fallback: load on first interaction if IntersectionObserver is unavailable
      loadPlayer();
    }
  };

  document.addEventListener('DOMContentLoaded', bootOnInteraction);
</script>

<style>
  .spotify-container {
    width: 100%;
  }

  .spotify-content {
    width: 100%;
  }

  .current-album {
    position: relative;
  }

  .spotify-load {
    background: #1db954;
    color: #fff;
    border: 2px solid #000;
    border-radius: 0.5rem;
    padding: 0.75rem 1.25rem;
    font-family: 'Poppins', sans-serif;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }

  .spotify-load:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 0 #000;
  }
</style>
